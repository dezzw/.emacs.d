{ lib
, python3
, melpaBuild
, trivialBuild
, fetchFromGitHub
, substituteAll
, git
, writeText
, unstableGitUpdater
}:

let
  rev = "b5e1f0bd7ded5b6dcb2db1456dd66185ef07d641";
  python = python3.withPackages (ps: with ps; [
    epc
    sexpdata
    six
    pynput
    (
      buildPythonPackage rec {
        pname = "pyobjc";
        version = "9.2";
        src = fetchPypi {
          inherit pname version;
          sha256 = "sha256-TWjfl28qnBJuHE0SUAIGG+PlL7GjGkLnzSaF6b/jc38=";
        };
        doCheck = false;
      }
    )
    inflect
    pyqt6
    pyqt6-sip
  ]);
in
melpaBuild {
  pname = "holo-layer";
  version = "20231216";

  src = fetchFromGitHub {
    owner = "manateelazycat";
    repo = "holo-layer";
    inherit rev;
    hash = "sha256-gioAnUsmbaTgrsCxoV8/oyLYtBBsCaqMpJwX2Lbr+wI=";
  };

  commit = rev;

  patches = [
    # Hardcode the python dependencies needed for lsp-bridge, so users
    # don't have to modify their global environment
    (substituteAll {
      src = ./hardcode-dependencies.patch;
      python = python.interpreter;
    })
  ];

  # packageRequires = [
  #   acm
  #   markdown-mode
  #   posframe
  # ];

  checkInputs = [
    git
  ];

  recipe = writeText "recipe" ''
    (holo-layer
      :repo "manateelazycat/holo-layer"
      :fetcher github
      :files
      ("*.el"
       "*.py"
       "plugin"
       "resources"))
  '';

  # doCheck = true;
  # checkPhase = ''
  #   runHook preCheck

  #   cd "$sourceRoot"
  #   mkfifo test.log
  #   cat < test.log &
  #   HOME=$(mktemp -d) python -m test.test

  #   runHook postCheck
  # '';

  passthru.updateScript = unstableGitUpdater { };

   meta = {
    description = "HoloLayer is a multimedia layer plugin specifically designed for Emacs.";
    license = lib.licenses.gpl3;
    platforms = lib.platforms.all;
  };
}
