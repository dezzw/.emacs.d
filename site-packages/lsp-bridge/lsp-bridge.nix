{
  lib,
  python3,
  melpaBuild,
  fetchFromGitHub,
  substituteAll,
  yasnippet,
  markdown-mode,
  basedpyright,
  git,
  go,
  gopls,
  tempel,
  unstableGitUpdater,
}:

let
  owner = "manateelazycat";
  repo = "lsp-bridge";
  version = "20241029";
  rev = "88e6f3639e984372f51b1017abc5dc07aa5154c8";
  hash = "sha256-hMhIVxfAAFXDj/1QwZeR1Rt/ICUsLYFtGgqmTS04GqI=";
  python = python3.withPackages (ps: with ps; [
    setuptools
    epc
    orjson
    sexpdata
    six
    paramiko
    rapidfuzz
    watchdog
  ]);

  acm = melpaBuild rec {
    pname = "acm";
    inherit version;

    src = fetchFromGitHub {
      inherit owner repo rev hash;
    };

    packageRequires = [ yasnippet ];

    files = ''("acm/*.el" "acm/icons")'';
  };
in
melpaBuild {
  pname = "lsp-bridge";
  inherit version;

  src = fetchFromGitHub {
    inherit owner repo rev hash;
  };

  commit = rev;

  patches = [
    # Hardcode the python dependencies needed for lsp-bridge, so users
    # don't have to modify their global environment
    (substituteAll {
      src = ./hardcode-dependencies.patch;
      python = python.interpreter;
    })
  ];

  packageRequires = [
    acm
    yasnippet
    markdown-mode
  ];

  checkInputs = [
    # Emacs packages
    tempel

    # Executables
    basedpyright
    git
    go
    gopls
    python
  ];

  files = ''
    ("*.el"
     "*.py"
     "core"
     "acm"
     "langserver"
     "multiserver"
     "resources")
  '';
  
  doCheck = false;

  passthru.updateScript = unstableGitUpdater { };

  meta = with lib; {
    description = "A blazingly fast LSP client for Emacs";
    homepage = "https://github.com/manateelazycat/lsp-bridge";
    license = licenses.gpl3Only;
  };
}
