{ lib
, python3
, melpaBuild
, fetchFromGitHub
, substituteAll
, yasnippet
, yasnippet-snippets
, markdown-mode
, posframe
, git
, pyright
, go
, gopls
, ruff
, writeText
, unstableGitUpdater
}:

let
  rev = "038e98abd4ef5a5630a353add2de91ae3bfd35e3";
  python = python3.withPackages (ps: with ps; [
    epc
    orjson
    sexpdata
    six
    paramiko
    rapidfuzz
  ]);
in
melpaBuild {
  pname = "lsp-bridge";
  version = "20230918.1017";

  src = fetchFromGitHub {
    owner = "manateelazycat";
    repo = "lsp-bridge";
    inherit rev;
    hash = "sha256-7GZusGpgXAsIPdE9ERzYlvFOLtl26HqekpvtoO1QLTs=";
  };

  commit = rev;

  patches = [
    # Hardcode the python dependencies needed for lsp-bridge, so users
    # don't have to modify their global environment
    (substituteAll {
      src = ./hardcode-dependencies.patch;
      python = python.interpreter;
    })
  ];

  packageRequires = [
    yasnippet
    yasnippet-snippets
    markdown-mode
    posframe
  ];

  checkInputs = [
    git
    pyright
    python
    go
    gopls
    ruff
  ];

  recipe = writeText "recipe" ''
    (lsp-bridge
      :repo "manateelazycat/lsp-bridge"
      :fetcher github
      :files
      ("*.el"
       "*.py"
       "acm"
       "core"
       "langserver"
       "multiserver"
       "resources"))
  '';

  doCheck = false;
  # checkPhase = ''
  #   runHook preCheck
  #
  #   cd "$sourceRoot"
  #   mkfifo test.log
  #   cat < test.log &
  #   HOME=$(mktemp -d) python -m test.test
  # 
  #   runHook postCheck
  # '';

  passthru.updateScript = unstableGitUpdater { };

  meta = with lib; {
    description = "A blazingly fast LSP client for Emacs";
    homepage = "https://github.com/manateelazycat/lsp-bridge";
    license = licenses.gpl3Only;
  };
}
