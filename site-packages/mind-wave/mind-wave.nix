{ lib
, pkgs
, melpaBuild
, substituteAll
, fetchFromGitHub
, python3
, markdown-mode
}:

let
  rev = "b787803ff745dde28727c10833b397d846fc1f7f";
  python = python3.withPackages (ps: with ps; [
    openai
    epc
    sexpdata
    six
  ]);
in
melpaBuild rec {
  pname = "mind-wave";
  version = "20231108.2154";
  src = fetchFromGitHub {
    owner = "manateelazycat";
    repo = "mind-wave";
    inherit rev;
    hash = "sha256-Uh3YcGQAFvxQjdvHQeZqy9NXFaQwGhkhFJuOn4CWG/k=";
  };
  commit = rev;

  patches = [
    # Hardcode the python dependencies needed for lsp-bridge, so users
    # don't have to modify their global environment
    (substituteAll {
      src = ./hardcode-dependencies.patch;
      python = python.interpreter;
    })
  ];

  # elisp dependencies
  packageRequires = [
    markdown-mode
  ];

  recipe = pkgs.writeText "recipe" ''
    (mind-wave
    :repo "manateelazycat/mind-wave"
    :fetcher github
    :files
    ("*.el"
    "*.py"))
  '';

  doCheck = true;
  passthru.updateScript = pkgs.unstableGitUpdater {};
  meta = with lib; {
    description = " Emacs AI plugin based on ChatGPT API ";
    homepage = "https://github.com/manateelazycat/mind-wave";
    license = licenses.gpl3Only;
  };
}
